<%-
local sys = require "luci.sys"
local http = require "luci.http"
local json = require "luci.jsonc"
local nixio = require "nixio"
-%>

<%
-- 设置响应头为JSON格式
http.prepare_content("application/json")

-- 获取系统负载信息
local load_avg = sys.exec("cat /proc/loadavg | awk '{print $1}'")
load_avg = tonumber(load_avg) or 0
local cpu_cores = tonumber(sys.exec("nproc 2>/dev/null")) or 1
local load_percentage = math.floor((load_avg / cpu_cores) * 100 + 0.5)

-- 获取内存使用信息
local memory_info = sys.exec("free | grep Mem")
local total_mem, used_mem, free_mem
if memory_info then
    total_mem, used_mem, free_mem = memory_info:match("Mem:%s+(%d+)%s+(%d+)%s+(%d+)")
    total_mem = tonumber(total_mem) or 0
    used_mem = tonumber(used_mem) or 0
    memory_usage = math.floor((used_mem / total_mem) * 100 + 0.5)
else
    memory_usage = 0
end

-- 获取网络连接状态
local has_network = sys.call("ping -c 1 -W 1 223.5.5.5 > /dev/null 2>&1") == 0

-- 防火墙安全检测
local drop_packets = sys.exec("iptables -L INPUT -nvx 2>/dev/null | grep -E 'DROP|REJECT' | awk '{sum += $1} END {print sum+0}'")
drop_packets = tonumber(drop_packets) or 0

local port_scan = sys.exec("logread | grep -i 'port.*scan\\|syn.*flood' | wc -l")
port_scan = tonumber(port_scan) or 0

local abnormal_conn = sys.exec("netstat -an 2>/dev/null | grep -E 'SYN_RECV|FIN_WAIT|TIME_WAIT' | wc -l")
abnormal_conn = tonumber(abnormal_conn) or 0

-- 计算安全评分
local security_score = 0
if drop_packets > 50 then security_score = security_score + 1 end
if port_scan > 3 then security_score = security_score + 1 end
if abnormal_conn > 10 then security_score = security_score + 1 end

-- CPU温度检测
local cpu_temp = "N/A"
local temp_files = {
    "/sys/class/thermal/thermal_zone0/temp",
    "/sys/class/hwmon/hwmon0/temp1_input",
    "/sys/devices/virtual/thermal/thermal_zone0/temp"
}

for _, temp_file in ipairs(temp_files) do
    local temp_raw = sys.exec("cat " .. temp_file .. " 2>/dev/null")
    if temp_raw and tonumber(temp_raw) then
        local temp_val = tonumber(temp_raw)
        if temp_val > 1000 then
            cpu_temp = string.format("%.1f", temp_val / 1000)
        else
            cpu_temp = string.format("%.1f", temp_val)
        end
        break
    end
end

-- 磁盘使用率
local disk_usage = sys.exec("df -h / | awk 'NR==2 {print $5}' | sed 's/%//'")
disk_usage = tonumber(disk_usage) or 0

-- 获取运行时间
local uptime_seconds = sys.exec("cat /proc/uptime | awk '{print $1}'")
uptime_seconds = tonumber(uptime_seconds) or 0

-- 格式化运行时间
local function format_uptime(seconds)
    if not seconds then return "N/A" end
    
    local days = math.floor(seconds / 86400)
    local hours = math.floor((seconds % 86400) / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    
    if days > 0 then
        return string.format("%d天 %d小时", days, hours)
    elseif hours > 0 then
        return string.format("%d小时 %d分钟", hours, minutes)
    else
        return string.format("%d分钟", minutes)
    end
end

-- 获取网络接口信息
local interfaces = {}
local network_info = sys.exec("ip -o addr show | grep 'inet ' | awk '{print $2\": \"$4}'")
if network_info then
    for line in network_info:gmatch("[^\r\n]+") do
        table.insert(interfaces, line)
    end
end

-- 获取当前连接数
local connections = sys.exec("netstat -tn 2>/dev/null | grep 'ESTABLISHED' | wc -l")
connections = tonumber(connections) or 0

-- 获取进程数量
local processes = sys.exec("ps | wc -l")
processes = tonumber(processes) or 0

-- 构建响应数据
local response = {
    -- 基础系统信息
    load_percentage = load_percentage,
    memory_usage = memory_usage,
    disk_usage = disk_usage,
    cpu_temp = cpu_temp,
    uptime = uptime_seconds,
    uptime_formatted = format_uptime(uptime_seconds),
    
    -- 网络信息
    has_network = has_network,
    connections = connections,
    interfaces = interfaces,
    
    -- 安全信息
    drop_packets = drop_packets,
    port_scan = port_scan,
    abnormal_conn = abnormal_conn,
    security_score = security_score,
    
    -- 系统状态
    processes = processes,
    
    -- 时间戳
    timestamp = os.time(),
    timestamp_formatted = os.date("%Y-%m-%d %H:%M:%S")
}

-- 输出JSON响应
http.write_json(response)
-%>